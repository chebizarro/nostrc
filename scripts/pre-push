#!/bin/bash
#
# Pre-push hook for nostrc
# Enforces build verification before push
#
# Install: cp scripts/pre-push .git/hooks/pre-push && chmod +x .git/hooks/pre-push
# Or: scripts/install-hooks.sh

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}=== Pre-push Build Verification ===${NC}"

# Check for _build directory
if [ ! -d "_build" ]; then
    echo -e "${RED}ERROR: _build directory not found${NC}"
    echo "Run: cmake -B _build && cmake --build _build"
    exit 1
fi

# Clean rebuild
echo -e "${YELLOW}Running clean build...${NC}"
rm -rf _build
cmake -B _build -DCMAKE_BUILD_TYPE=Debug 2>&1 | tail -5

if ! cmake --build _build 2>&1; then
    echo -e "${RED}BUILD FAILED - Push blocked${NC}"
    echo "Fix build errors before pushing."
    exit 1
fi

echo -e "${GREEN}Build succeeded${NC}"

# Run tests if test directory exists
if [ -d "libgo/tests" ] || [ -d "tests" ]; then
    echo -e "${YELLOW}Running tests...${NC}"
    if ! ctest --test-dir _build --output-on-failure 2>&1; then
        echo -e "${RED}TESTS FAILED - Push blocked${NC}"
        echo "Fix failing tests before pushing."
        exit 1
    fi
    echo -e "${GREEN}Tests passed${NC}"
fi

echo -e "${GREEN}=== All checks passed - Push allowed ===${NC}"
exit 0
