# Flatpak manifest for GNostr Signer
# Build with: flatpak-builder --user --install build-dir org.gnostr.Signer.yml
#
# Prerequisites:
#   flatpak install flathub org.gnome.Platform//47 org.gnome.Sdk//47
#
app-id: org.gnostr.Signer
runtime: org.gnome.Platform
runtime-version: '47'
sdk: org.gnome.Sdk
command: gnostr-signer

finish-args:
  # D-Bus IPC for desktop integration
  - --share=ipc
  # Display protocols
  - --socket=fallback-x11
  - --socket=wayland
  # Secret Service access (GNOME Keyring/libsecret) for secure key storage
  - --talk-name=org.freedesktop.secrets
  # Own the org.nostr.Signer D-Bus name for NIP-55L interface
  - --own-name=org.nostr.Signer
  # Network access for Nostr relay connections (NIP-46 bunker, profile fetching)
  - --share=network
  # GSettings/DConf access for persistent settings
  - --metadata=X-DConf=migrate-path=/org/gnostr/Signer/
  # Desktop notifications for signing requests and alerts
  - --talk-name=org.freedesktop.Notifications
  # Portal access for file chooser (backup/restore) and other portals
  - --talk-name=org.freedesktop.portal.Desktop
  - --talk-name=org.freedesktop.portal.FileChooser
  # Background portal for daemon auto-start
  - --talk-name=org.freedesktop.portal.Background

cleanup:
  - /include
  - /lib/pkgconfig
  - /lib/cmake
  - /lib/*.a
  - /lib/*.la
  - /share/man
  - /share/doc
  - /share/gtk-doc
  - /share/aclocal

modules:
  # libsecp256k1 - Elliptic curve cryptography for Nostr (Schnorr signatures)
  - name: libsecp256k1
    buildsystem: autotools
    config-opts:
      - --enable-module-recovery
      - --enable-module-extrakeys
      - --enable-module-schnorrsig
      - --disable-benchmark
      - --disable-tests
      - --disable-exhaustive-tests
    sources:
      - type: git
        url: https://github.com/bitcoin-core/secp256k1.git
        tag: v0.5.1
        commit: 642c885b6102725e25623738529895a95addc7d4

  # libsodium - Modern cryptography library (NIP-44, secure memory)
  - name: libsodium
    buildsystem: autotools
    config-opts:
      - --disable-static
    sources:
      - type: git
        url: https://github.com/jedisct1/libsodium.git
        tag: 1.0.20-RELEASE
        commit: d72e3f01c37e1c743cc7151a8e23c6e8ee592770

  # nsync - Google's C synchronization library
  - name: nsync
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS=ON
      - -DNSYNC_ENABLE_TESTS=OFF
    sources:
      - type: git
        url: https://github.com/google/nsync.git
        tag: '1.29.2'

  # jansson - JSON library for C
  - name: jansson
    buildsystem: meson
    config-opts:
      - -Ddocs=disabled
      - -Dtests=disabled
    sources:
      - type: git
        url: https://github.com/akheron/jansson.git
        tag: v2.14
        commit: 684e18c927e89615c2d501737e90018f4930d6c5

  # flatcc - FlatBuffers compiler and runtime for C (for nostrdb)
  - name: flatcc
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DFLATCC_INSTALL=ON
      - -DFLATCC_TEST=OFF
      - -DFLATCC_REFLECTION=OFF
    sources:
      - type: git
        url: https://github.com/dvidelern/flatcc.git
        tag: v0.6.1
        commit: 034f15e4a9e26e21c72a1e2bdd37eb9ed1bdc625

  # libwebsockets - WebSocket client/server library for relay connections
  - name: libwebsockets
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DLWS_WITH_SSL=ON
      - -DLWS_WITH_SHARED=ON
      - -DLWS_WITH_STATIC=OFF
      - -DLWS_WITHOUT_TESTAPPS=ON
      - -DLWS_WITHOUT_TEST_SERVER=ON
      - -DLWS_WITHOUT_TEST_SERVER_EXTPOLL=ON
      - -DLWS_WITHOUT_TEST_PING=ON
      - -DLWS_WITHOUT_TEST_CLIENT=ON
      - -DLWS_WITH_GLIB=ON
      - -DLWS_WITH_LIBUV=OFF
      - -DLWS_WITH_LIBEVENT=OFF
    sources:
      - type: git
        url: https://github.com/warmcat/libwebsockets.git
        tag: v4.3.3
        commit: b0a749c8e7a8294b68581ce4feac224e51768bcf

  # The main nostrc/gnostr-signer application
  - name: gnostr-signer
    buildsystem: simple
    build-options:
      env:
        # Help CMake find flatcc
        CMAKE_PREFIX_PATH: /app
    build-commands:
      # Configure and build the project
      - |
        cmake -S . -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/app \
          -DBUILD_APPS=ON \
          -DBUILD_TESTING_FRAMEWORK=OFF \
          -DGNOSTR_ENABLE_GOA=OFF \
          -DGNOSTR_ENABLE_SEAHORSE_HELPERS=OFF \
          -DLIBNOSTR_WITH_NOSTRDB=OFF
      - cmake --build build --target gnostr-signer gnostr-signer-daemon -j
      # Install binaries
      - install -Dm755 build/apps/gnostr-signer/gnostr-signer /app/bin/gnostr-signer
      - install -Dm755 build/apps/gnostr-signer/gnostr-signer-daemon /app/bin/gnostr-signer-daemon
      # Install desktop file
      - install -Dm644 apps/gnostr-signer/data/org.gnostr.Signer.desktop /app/share/applications/org.gnostr.Signer.desktop
      # Install AppStream metainfo
      - install -Dm644 apps/gnostr-signer/data/org.gnostr.Signer.metainfo.xml /app/share/metainfo/org.gnostr.Signer.metainfo.xml
      # Install icons (scalable SVG)
      - install -Dm644 apps/gnostr-signer/data/icons/hicolor/scalable/apps/org.gnostr.Signer.svg /app/share/icons/hicolor/scalable/apps/org.gnostr.Signer.svg
      # Install GSettings schema and compile
      - install -Dm644 apps/gnostr-signer/data/org.gnostr.Signer.gschema.xml /app/share/glib-2.0/schemas/org.gnostr.Signer.gschema.xml
      - glib-compile-schemas /app/share/glib-2.0/schemas/
      # Install D-Bus service file (Flatpak-specific with /app/bin path)
      - install -Dm644 apps/gnostr-signer/packaging/flatpak/org.nostr.Signer.service /app/share/dbus-1/services/org.nostr.Signer.service
    sources:
      - type: dir
        path: ../../../..
